<div class="container body-content">

@if (profile) {
    <div class="row sectionHeader">
      <div class="sectionHeading noBorder">User Profile</div>
    </div>

    <div class="row userProfile">
      <div class="col-md-4">
        <div style="display:flex; flex-direction:column; align-items:flex-start;">
        @if (!profile.profileImageUrl) {
          <img
            src="assets/images/blankpicture.png"
            class="profile-img-box"
            alt="Default profile image" />
        } @else {
          <div
            class="profile-img-box"
            [style.background-image]="'url(' + profile.profileImageUrl + ')'"
          ></div>
        }

        @if (currentUser$ | async; as cu) {
          @if (cu.userName === profile.userName) {
            <label
              class="btn btn-sm btn-dark"
              style="display:inline-flex; align-items:center; justify-content:center; gap:5px; margin-top:10px; width:auto; cursor:pointer; border-radius:999px; transition: background 0.2s, box-shadow 0.2s;"
              onmouseenter="this.style.background='#444'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'; this.style.transform='translateY(-1px)'"
              onmouseleave="this.style.background=''; this.style.boxShadow=''; this.style.transform=''">
              <i class="material-icons" style="font-size:16px">photo_camera</i>
              Change Photo
              <input
                type="file"
                name="file"
                accept="image/*"
                style="display:none"
                (change)="onImageSelected($event)" />
            </label>
          }

          @if (cu.userName !== profile.userName) {
            <div style="display:flex; gap:10px; margin-top:12px;">
              @if (!isFollowing) {
                <button class="action-btn-follow follow" (click)="toggleFollow()">
                  <i class="material-icons" style="font-size:16px">person_add</i>
                  Follow
                </button>
              } @else {
                <button class="action-btn-follow unfollow" (click)="toggleFollow()">
                  <i class="material-icons" style="font-size:16px">person_remove</i>
                  Unfollow
                </button>
              }
              <a class="action-btn-comment" [routerLink]="['/profile-comment/create', profile.userId]">
                <i class="material-icons" style="font-size:16px">mode_comment</i>
                Comment
              </a>
            </div>
          }
        }
        </div>
      </div>

      <div class="col-md-8" style="display:flex; flex-direction:column; justify-content:center;">
        <span id="userName">
          {{ profile.userName }}
          @if (currentUser$ | async; as cu) {
            @if (cu.userName === profile.userName) {
              <a
                id="userEditLabel"
                class="inline-icon material-icons"
                [routerLink]="['/profile/edit-username', profile.userId]"
                style="text-decoration:none; display:inline-block; color:black">
                edit
              </a>
            }
          }
        </span>

        <div style="display:flex; align-items:center; gap:6px;">
          <span id="userRating">Current Rating:</span>
          <span class="badge rounded-circle" style="background-color:skyblue; width:auto; align-self:auto;">{{ profile.userRating }}</span>
        </div>

        <span id="userCreatedLabel">
          Member Since: {{ profile.memberSince | date: 'mediumDate' }}
        </span>

        <div style="display:flex; gap:12px; margin-top:10px;">
          <a
            [routerLink]="['/profile/followers', profile.userId]"
            class="follower-pill" style="text-decoration: none;">
            <i class="material-icons" style="font-size:16px">group</i>
            <span class="follower-pill-count">{{ profile.followers }}</span>
            <span class="follower-pill-label">Followers</span>
          </a>
          <a
            [routerLink]="['/profile/following', profile.userId]"
            class="follower-pill" style="text-decoration: none;">
            <i class="material-icons" style="font-size:16px">person_add</i>
            <span class="follower-pill-count">{{ profile.following }}</span>
            <span class="follower-pill-label">Following</span>
          </a>
        </div>

        <div id="userBioLabel" style="margin-top:12px; margin-bottom:4px;">{{ profile.bio }}</div>

        @if (currentUser$ | async; as cu) {
          @if (cu.userName === profile.userName) {
            <div style="margin-top:10px;">
              <a
                [routerLink]="['/profile/edit-bio', profile.userId]"
                class="btn btn-sm btn-outline-dark"
                style="display:inline-flex; align-items:center; gap:5px;">
                <i class="material-icons" style="font-size:16px">{{ profile.bio ? 'edit' : 'add' }}</i>
                {{ profile.bio ? 'Edit Bio' : 'Add Bio' }}
              </a>
            </div>
          }
        }
      </div>
    </div>
}

<div class="row" id="replyDivider"></div>

@if (profile) {
  <div class="row postReplyContent">
    @for (comment of profile.profileComments; track comment.id) {
      <div class="row replyContent">
        <div class="col-md-4 replyAuthorContainer">
          <div
            class="postAuthorImage"
            [style.background-image]="
              comment.commentUserImagePath
                ? 'url(' + comment.commentUserImagePath + ')'
                : 'url(assets/images/blankpicture.png)'
            "
            style="background-size:100%">
          </div>

          <a [routerLink]="['/profile', comment.commentUserId]">
            <strong>{{ comment.commentUserName }}</strong>
          </a>

          <span class="badge rounded-circle" style="background-color:skyblue">
            {{ comment.commentUserRating }}
          </span>
          <br />
          <span class="postDate">{{ comment.date | date: 'mediumDate' }}</span>
        </div>

        <div class="col-md-8 replyContentContainer">

          <!-- View mode -->
          @if (editingCommentId !== comment.id) {
            <div class="postContent" [innerHTML]="comment.commentContent"></div>

            <!-- Show edit/delete only to comment author -->
            @if (currentUser$ | async; as cu) {
              @if (cu.userId === comment.commentUserId) {
                <div style="display:flex; gap:8px; margin-top:8px;">
                  <button
                    class="btn btn-sm btn-outline-secondary"
                    style="display:inline-flex; align-items:center; gap:4px;"
                    (click)="startEdit(comment)">
                    <i class="material-icons" style="font-size:14px">edit</i>
                    Edit
                  </button>
                  <button
                    class="btn btn-sm btn-outline-danger"
                    style="display:inline-flex; align-items:center; gap:4px;"
                    (click)="deleteComment(comment.id!)">
                    <i class="material-icons" style="font-size:14px">delete</i>
                    Delete
                  </button>
                </div>
              }
            }

          } @else {
            <!-- Inline edit mode -->
            <textarea
              class="form-control"
              rows="4"
              [(ngModel)]="editContent"
            ></textarea>
            <div style="display:flex; gap:8px; margin-top:8px;">
              <button
                class="btn btn-sm btn-primary"
                style="display:inline-flex; align-items:center; gap:4px;"
                (click)="saveEdit(comment.id!)">
                <i class="material-icons" style="font-size:14px">save</i>
                Save
              </button>
              <button
                class="btn btn-sm btn-outline-secondary"
                style="display:inline-flex; align-items:center; gap:4px;"
                (click)="cancelEdit()">
                <i class="material-icons" style="font-size:14px">close</i>
                Cancel
              </button>
            </div>
          }

        </div>
      </div>
    } @empty {
      <div class="noPosts">
        <h3>There are no comments on this profile.</h3>
      </div>
    }
  </div>
}

</div>
